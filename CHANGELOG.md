# CHANGELOG

## [项目重组] - 2025-01-27 (最新)

### 🧹 项目结构大整理
- **清理冗余服务器文件**:
  - 分析发现7个功能重复的服务器文件，保留2个主要版本
  - 删除 `server.js`, `server.mjs`, `scraper-server.js`, `scraper-server.cjs`
  - 保留 `scraper-server-unified.cjs` 和 `scraper-server-advanced.cjs`
- **重组目录结构**:
  - 移除冗余的 `backend/public/images/` 目录
  - 统一使用 `public/images/` 存储静态资源
  - 创建 `src/__tests__/` 目录整理测试文件
- **配置文件优化**:
  - 添加 `.env.example` 环境变量示例文件
  - 优化 `.gitignore` 文件，添加更完善的忽略规则
  - 更新 `package.json` 脚本引用
- **测试文件归类**:
  - 移动所有测试文件到 `src/__tests__/` 目录
  - 重命名测试文件使其符合命名规范

### 📊 整理成果
- 减少约 40% 的冗余文件
- 更清晰的项目结构层次
- 提高代码可维护性
- 优化开发体验

## [功能更新] - 2025-01-27

### 🔧 修复
- **网页抓取功能修复**:
  - 修复了后端抓取服务器连接被拒绝的问题 (`net::ERR_CONNECTION_REFUSED`)
  - 解决了ES模块与CommonJS兼容性问题，改用 `scraper-server.cjs` 文件
  - 改进了错误处理和用户提示，添加了清晰的状态指示和错误信息
  - 更新了npm脚本配置，使用正确的服务器文件
  - 添加了 `concurrently` 依赖用于同时运行前端和后端服务
  - 新增 `npm run scraper` 和 `npm run start-all` 脚本命令

### 🚀 网页抓取功能优化
- **后端服务器改进**:
  - 增强了服务器启动日志，添加表情符号和清晰的状态提示
  - 添加了端口占用检测和错误处理
  - 实现了优雅关闭功能，支持 Ctrl+C 安全退出
  - 改进了API端点响应，确保正确的CORS支持
- **前端抓取逻辑优化**:
  - 增强了错误信息提示，帮助用户了解问题原因
  - 添加了后端服务器状态检测和友好提示
  - 改进了日志输出，使用表情符号增强可读性

### 🤖 **重大升级：Puppeteer无头浏览器支持**
- **智能抓取策略**:
  - 微信公众号链接自动使用Puppeteer无头浏览器抓取
  - 普通网站优先使用HTTP方式（更快），失败时自动切换到Puppeteer
  - 支持JavaScript渲染的现代网站抓取
- **反爬虫机制应对**:
  - 隐藏webdriver特征，模拟真实浏览器行为
  - 设置完整的浏览器环境和请求头
  - 智能等待页面加载完成和网络空闲
- **微信特定优化**:
  - 针对微信公众号内容的专门选择器
  - 清理分享按钮、二维码等无关元素
  - 保留文章核心内容和格式

### 使用说明
- **标准抓取模式**：
  - `npm run scraper` - 仅启动标准后端抓取服务器
  - `npm run start-all` - 同时启动前端和标准后端服务
- **高级抓取模式**（推荐）：
  - `npm run scraper-advanced` - 启动支持Puppeteer的高级抓取服务器
  - `npm run start-all-advanced` - 同时启动前端和高级后端服务
- **手动启动**：
  - `node scraper-server.cjs` - 标准服务器
  - `node scraper-server-advanced.cjs` - 高级服务器

## [未发布版本] - 2025-05-23

### 界面优化
- **分离式标题栏设计**:
  - 移除了全局Header组件，改为左右分区独立的标题栏设计
  - 左侧阅读区域：包含ClipNote品牌标识、"My Saved Articles"标题、"Add New"按钮和主题切换
  - 右侧对话区域：独立的AI助手标题栏，包含助手图标、状态指示和功能按钮（清空对话、设置）
  - 实现了"阅读区域是阅读区域，对话区域是对话区域"的清晰界面分离
  - 优化了ChatPanel的视觉设计，增加了更好的消息气泡样式和加载动画
  - 添加了AI助手的工作模式指示（文章分析模式/收藏分析模式）

### 新增
- **主页AI功能：文章列表上下文感知 (阶段五)**:
  - 修改 `App.tsx` 以将完整的 `articles` 列表传递给 `ChatPanel` 组件。
  - 更新 `ChatPanel.tsx` 以接收 `articles` prop。
  - 当用户在主页（文章列表页）提问时，`ChatPanel` 会将收藏的文章列表中的前10篇文章的标题和摘要（摘要限制长度）作为系统消息发送给 Azure OpenAI，为AI提供关于整个收藏集的上下文。

- **详情页AI功能：文章上下文感知 (阶段四)**:
  - 修改 `App.tsx` 以将当前查看的文章 (`currentArticle`) 传递给 `ChatPanel` 组件。
  - 更新 `ChatPanel.tsx` 以接收 `currentArticle` prop。
  - 当用户在文章详情页提问时，`ChatPanel` 会将当前文章的标题和内容（或摘要）作为系统消息发送给 Azure OpenAI，为AI提供上下文，使其能够针对特定文章进行回答。

- **AI 服务集成与聊天功能实现 (阶段二和三)**:
  - 创建了 `src/services/aiService.ts` 模块，用于封装与 Azure OpenAI 服务的API交互。
  - 在 `ChatPanel.tsx` 中实现了完整的聊天逻辑：
    - 管理聊天消息、用户输入、加载状态和错误状态。
    - 用户发送消息后，调用 Azure OpenAI 服务获取回复。
    - 动态渲染聊天气泡，区分用户和AI角色。
    - 提供加载指示和错误提示。
    - 实现自动滚动、Enter键发送等交互优化。
  - **重要**: AI 功能依赖于用户在 `.env.local` 文件中正确配置的 `VITE_AZURE_OPENAI_ENDPOINT` 和 `VITE_AZURE_OPENAI_KEY` 环境变量。

- **AI 聊天面板界面集成 (阶段一)**:
  - 创建了基础的 `ChatPanel.tsx` 组件，包含聊天消息和输入框的占位符界面。
  - 修改了 `App.tsx` 以引入两栏布局，左侧为主要应用内容，右侧为专用的、常驻的 AI 聊天面板。

### 🔥 网页内容抓取改进
- **增强的内容格式保留** - 改进了爬虫服务器，更好地保留HTML结构和格式
  - 保留标题、段落和列表结构
  - 智能清理广告和无关内容
  - 提取结构化文本，保留格式信息
- **多格式内容支持** - 改进了前端对不同内容格式的处理
  - 支持HTML富文本格式显示
  - 支持结构化文本和纯文本切换
  - 自动检测内容格式并选择最佳展示方式
- **粘贴功能增强** - 改进了粘贴事件处理
  - 支持直接粘贴HTML内容并保留格式
  - 使用DOMPurify安全清理HTML
  - 自动识别内容类型并切换到适当模式
- **内容来源检测** - 新增功能可以自动识别内容来源
  - 支持识别新闻、博客和一般文章
  - 基于URL和标题进行智能分类

### 改进
- ✨ 重构了文章列表页面的布局：将"Add New"按钮从全局 Header 移至"My Saved Articles"标题旁边，创建了更统一的页面操作区域。

### 修复
- 🐛 修复了在添加右侧聊天面板后，主内容区域与固定头部（Header）重叠导致布局混乱的问题。通过在 `App.tsx` 中为主要内容容器添加 `pt-16` (padding-top: 4rem) 解决。

## [未发布版本] - 2024-01-27 (之前更新)

### 🧹 代码和依赖清理
- **移除 `uuid` 依赖** - 由于全面采用 Supabase，不再需要客户端生成 UUID。
  - 从 `package.json` 中删除了 `uuid` 和 `@types/uuid`。
  - 更新了 `mockData.ts` 以使用简单的字符串 ID 代替 `uuidv4()`。
- **更新 Supabase CLI 版本** - 将 `package.json` 中的 `supabase` CLI 更新到 `^2.23.4` 以解决 `npm install` 问题。

### 🚀 重大架构更新 - 全面采用 Supabase 云存储
- ☁️ **移除本地存储** - 应用现在完全依赖 Supabase 进行数据存储。
- 🧹 **代码简化** - 删除了 `LocalStorageService` 及所有相关的存储模式切换、数据同步和回退逻辑。
- 🎯 **单一数据源** - 所有文章数据统一由 Supabase 管理，确保数据一致性。
- ✨ **更精简的上下文** - `ArticlesContext` 逻辑更清晰，移除了复杂的存储判断。
- ⬆️ **提升可维护性** - 减少了代码复杂度，使未来功能迭代更方便。

### 🔧 重要修复 - 数据一致性和同步 (已移除)
- (此部分功能已通过全面切换到 Supabase 解决，不再需要单独的数据同步机制)

### 新增功能
- 🗑️ **文章删除功能** - 支持在列表和详情页面删除文章
  - 在文章卡片上添加删除按钮（悬停显示）
  - 在文章详情页面头部添加删除按钮
  - 智能确认对话框，防止误删操作
  - (现在仅支持 Supabase 模式的删除)
  - 删除后自动更新界面和返回列表

### 用户体验改进
- 🎯 删除确认对话框显示文章标题，提高操作准确性
- ⚡ 删除操作后自动从当前视图移除，无需手动刷新
- 🔒 删除按钮位置合理，避免误操作但易于访问

### 修复
- 🐛 **修复刷新页面后文章丢失的问题** - 重构了存储检测和数据加载逻辑
- 🔧 优化了初始化流程，确保存储模式检测和数据加载的原子性
- 📝 改进了错误处理，增加了详细的日志输出用于调试

### 改进
- ⚡ 移除了不必要的 setTimeout 延迟，提高了应用启动速度
- 🧹 简化了存储服务获取逻辑，减少了状态依赖
- 📊 增加了数据加载的详细日志，便于问题排查

## [未发布版本] - 2024-01-27

### 修复
- 🐛 修复了富文本内容中 HTML 标签在标题中显示的问题
- 🐛 修复了 Supabase 配置中 `process.env` 在浏览器环境中的错误，改用 `import.meta.env`
- 🔧 修正了 Supabase 项目 URL 中的拼写错误
- 📝 改进了内容添加时的标题和摘要提取逻辑，智能清理 HTML 标签

### 改进
- ✨ 智能标题提取：支持从 HTML 标签（h1-h6, title）和 Markdown 标题中提取
- 🎯 改进的摘要生成：自动跳过标题部分，提取更有意义的摘要内容
- 🧹 增强的内容清理：移除 HTML 标签和实体，确保标题显示干净

## [未发布]

### 🔄 **存储方案切换 - 本地存储**

- ✅ **新增本地存储服务 (`LocalStorageService`)**
  - 完整的 CRUD 操作支持
  - 数据持久化存储在浏览器本地
  - 支持导入导出功能
  - 完全兼容原有 API 接口
- 🔧 **切换存储后端**
  - 从 Supabase 云数据库切换到浏览器本地存储
  - 解决网络访问限制问题
  - 保持所有功能完整可用
- 📱 **改进用户体验**
  - 添加存储状态提示
  - 更快的响应速度（无需网络请求）
  - 离线使用支持

### 重大更新 - Supabase 集成（备用方案）

- 🎉 **集成 Supabase 云数据库**
  - 替换本地模拟数据为真实的云存储服务
  - 文章现在永久保存在云端，支持跨设备同步
  - 添加了完整的 CRUD 操作（创建、读取、更新、删除）

### 数据库功能

- 创建了 PostgreSQL 数据库表结构
  - 支持文章标题、内容、摘要、标签等完整信息
  - 自动时间戳（创建时间、更新时间）
  - 文章来源分类（微信、LinkedIn、Reddit 等）
  - 已读/未读状态管理
- 添加了数据库索引以提高查询性能
- 实现了行级安全策略 (RLS)

### 技术架构

- 新增 `LocalStorageService` 本地存储服务层
  - 提供与云数据库相同的 API 接口
  - 支持文章搜索、标签过滤、全文检索
  - 数据导入导出功能
- 新增 `ArticleService` 数据服务层（Supabase）
  - 封装所有 Supabase 数据库操作
  - 支持文章搜索、标签过滤、全文检索
  - 错误处理和异常管理
- 更新了 TypeScript 类型定义
  - 适配 Supabase 数据库字段命名约定
  - 添加了 `ArticleInsert` 和 `ArticleUpdate` 类型
- 重构了 `ArticlesContext`
  - 支持动态切换存储后端
  - 实现真实的数据库操作替代模拟数据

### 依赖管理

- 添加 `@supabase/supabase-js` 客户端库
- 创建了 Supabase 配置文件

### 数据迁移

- 提供了完整的数据库创建脚本 (`database.sql`)
- 包含表结构、索引、触发器和安全策略
- 支持从现有模拟数据无缝迁移到真实数据库

### 新增

- 添加了多格式内容检测和渲染功能
  - 支持自动检测 HTML、Markdown 和纯文本格式
  - 支持在添加内容时预览格式化后的效果
  - 改进了内容解析和处理逻辑
- 增强了格式检测功能
  - 添加对 Office 格式(DOCX/XLSX)的支持
  - 添加对 RTF 格式的支持
  - 支持从粘贴事件中检测各种格式
  - 添加文件上传功能，支持常见文档格式

### 技术改进

- 添加了内容格式检测工具 `formatDetection.ts`
- 创建了文档转换工具 `documentConverter.ts`，用于处理各种文档格式
- 创建了新组件 `ContentPreview.tsx` 用于内容预览
- 更新了 `AddLinkModal.tsx`，添加了内容编辑和预览切换功能
- 增强了粘贴和文件上传功能
- 改进了 `mockData.ts` 中的内容处理逻辑，支持从不同格式提取标题和摘要

### 依赖

- 添加 `mammoth` 库用于解析 DOCX 文件
- 添加 `xlsx` 库用于解析电子表格
- 添加 `rtf-parser` 库用于解析 RTF 文档
- 添加 `file-type` 库用于检测文件类型

### 更新

- 将 Header 组件中的按钮文本从 `Add Link` 改为 `Add New`

## [未发布版本] - 2024-01-27

### 修复
- 🐛 修复了富文本内容中 HTML 标签在标题中显示的问题
- 🐛 修复了 Supabase 配置中 `process.env` 在浏览器环境中的错误，改用 `import.meta.env`
- 🔧 修正了 Supabase 项目 URL 中的拼写错误
- 📝 改进了内容添加时的标题和摘要提取逻辑，智能清理 HTML 标签

### 改进
- ✨ 智能标题提取：支持从 HTML 标签（h1-h6, title）和 Markdown 标题中提取
- 🎯 改进的摘要生成：自动跳过标题部分，提取更有意义的摘要内容
- 🧹 增强的内容清理：移除 HTML 标签和实体，确保标题显示干净

## [0.2.0] - 2024-01-27

### 新增功能
- ☁️ 集成 Supabase 云数据库存储
- 🔄 智能存储检测和自动切换系统
- 💾 本地存储备用方案
- 🛠️ 自动化 Supabase 设置脚本
- 📊 实时存储状态显示

### 数据库和存储
- 🗄️ 完整的数据库表结构设计
- 🔐 行级安全策略配置
- 🔍 高性能数据库索引
- 🔄 自动时间戳更新触发器
- 📱 跨设备数据同步支持

### 用户体验
- 🎨 存储模式可视化指示器（☁️ 云存储 vs 💾 本地存储）
- ⚡ 智能故障转移，网络问题时自动切换到本地存储
- 🚀 一键设置命令：`npm run setup-supabase`
- 📄 详细的设置说明和错误处理

## [0.1.0] - 2024-01-26

### 初始发布
- 📱 基础文章收集和管理功能
- 🔗 支持链接和直接内容添加
- 📝 文章阅读界面
- 🏷️ 多平台来源支持（微信、LinkedIn、Reddit等）
- 🎨 现代化 UI 设计
- 🌓 深色/浅色主题支持

## [未发布] - 2024-12-19

### 🚀 重大更新：统一智能抓取系统
- ✨ **全新统一抓取服务器** (`scraper-server-unified.cjs`)
  - 整合基础抓取、高级抓取(Puppeteer)、图片下载功能于一体
  - 智能模式选择：自动检测网站特征并选择最佳抓取方式
  - 用户可手动选择抓取模式：智能选择/强制高级模式/基础模式
  - 统一的图片处理：自动下载、去重、缓存优化

### 新增功能
- 🖼️ **完整图片支持**
  - 自动下载网页中的图片并保存到本地 (`public/images/` 目录)
  - 新增图片画廊组件 (`ImageGallery.tsx`) 用于展示抓取的图片
  - 支持图片预览、下载和全屏查看
  - 图片去重和缓存机制，避免重复下载
  - 支持常见图片格式：JPEG、PNG、GIF、WebP、SVG
  - 文件大小限制 (5MB) 和类型验证

- 🤖 **智能抓取模式**
  - 自动识别微信公众号、知乎、微博等需要高级抓取的网站
  - 基础HTTP抓取适用于大多数静态网站
  - Puppeteer高级抓取突破反爬虫限制
  - 优雅降级：高级模式失败时自动切换到基础模式

### 改进
- 🔧 简化启动方式：现在只需 `npm start` 即可启动完整功能
- 🔧 更新用户界面：在抓取选项中可选择图片下载和抓取模式
- 🔧 统一错误处理和日志记录
- 🔧 减少代码重复，提高维护性

### 技术详情
- 图片通过 MD5 哈希命名，避免重复存储
- 支持相对路径和绝对路径图片 URL 解析
- 浏览器实例复用，提升性能
- 完善的错误处理和回退机制
- 响应式设计，支持深色主题

### 迁移指南
- **推荐使用**: `npm start` （统一抓取服务器）
- **向后兼容**: 旧的启动脚本仍然可用
  - `npm run scraper-legacy` - 原始基础抓取
  - `npm run scraper-advanced` - 高级抓取
  - `npm run scraper-images` - 图片抓取

## [2024-01-XX] - 修复抓取服务器HTTP头错误

### 修复
- 🔧 修复了统一抓取服务器中HTTP请求头undefined错误
- 🌐 移除了会导致"Invalid value \"undefined\" for header \"Referer\""的问题
- ✅ 优化了HTTP请求头处理逻辑，只在需要时添加Referer头
- 🚀 恢复了网页抓取和图片下载功能的完整工作状态

### 技术细节
- 将静态headers对象改为动态构建，避免undefined值
- 为图片请求单独处理Referer头的设置
- 确保所有HTTP请求头都有有效值
